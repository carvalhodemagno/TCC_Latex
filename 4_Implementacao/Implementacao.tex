%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Desenvolvimento e Implementação}
\label{chapter:desenvolvimento}
Este capítulo apresenta detalhadamente o que foi feito para desenvolver e implementar o sistema de gerenciamento e controle remoto para condicionadores de ar, levando em conta 3 pilares principais: \textit{Hardware}, \textit{Firmware} e Aplicativo \textit{mobile}.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{\textit{Hardware}}
\label{section_hardware}

A partir dos circuitos elétricos previamente citados na seção \ref{subsec:metodos_hardware}, foi realizado um estudo nos documentos de \textit{Reference Design} e \textit{Datasheets} disponibilizados pelos fabricantes dos CI's utilizados, de modo a verificar todas as considerações para o correto funcionamento dos circuitos. O documento principal utilizado foi o guia do usuário para o MCP39F521 \cite{MCP39f521_user_guide}, que auxiliou principalmente no \textbf{Circuito de Medição e Sensoriamento}. Elaborou-se então os esquemáticos elétricos, ilustrados nas figuras \ref{fig:Schematic_Power_Supply}, \ref{fig:Schematic_Core_Processor} e \ref{fig:Schematic_Meter}.

\begin{figure}[H]
	\centering
	\includegraphics[width=1\columnwidth]{figuras/Schematic_Power_Supply}
	\caption{Esquemático elétrico do Circuito de alimentação e de ativação do Condicionador de Ar.}
	\label{fig:Schematic_Power_Supply}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\columnwidth]{figuras/Schematic_Core_Processor}
	\caption{Esquemático elétrico referente ao Circuito do microcontrolador e de conexão com \textit{Wi-Fi}.}
	\label{fig:Schematic_Core_Processor}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=1\columnwidth]{figuras/Schematic_Meter}
	\caption{Esquemático elétrico do Circuito de Medição de energia elétrica e sensoriamento.}
	\label{fig:Schematic_Meter}
\end{figure}

A comunicação entre o microcontrolador e o circuito de medição de energia elétrica é realizada através de I2C, por meio dos sinais "SDA"\,e "SCL", já a interação realizada com o circuito de acionamento da contatora e o sensor de presença é por meio de escrita e leitura de GPIO's, respectivamente pelos sinais "RELAY\_GPIO"\,e "MOTION\_SENS".

O relé utilizado para acionamento da contatora é controlado com tensão de 5V DC, como a tensão usada para alimentar a placa é do tipo alternada, foi utilizado com conversor de tensão AC/DC, "U3"\,na figura \ref{fig:Schematic_Power_Supply}, capaz de aceitar padrões 110 e 220 como entrada, convertendo-a para tensão DC de 5V. Por outro lado, o microcontrolador, o medidor de energia e o sensor de presença são alimentados com tensão igual a 3.3V, portanto foi utilizado um regulador linear, "U4"\,na figura \ref{fig:Schematic_Power_Supply}, para regular a tensão de 5V para 3.3V.

A partir da finalização do desenvolvimento dos esquemáticos elétricos, é possível gerar a lista de todos os componentes, chamada de BOM (Bill Of Materials), representada pela tabela \ref{table:lista_material}, possibilitando a aquisição para futura prototipagem da PCB.

\begin{table}[H]
	\caption{Lista de materiais}	
	\label{table:lista_material}
	\begin{center}
		\begin{tabular}{|c|c|}
			\hline
		Componente & Quantidade \\ \hline
		Capacitor cerâmico SMD 0603 100nF & 10 \\ \hline
		Capacitor de alumínio polarizado SMD 10uF & 3 \\ \hline
		Capacitor cerâmico SMD 0603 33nF & 4 \\ \hline
		Capacitor cerâmico SMD 0603 10uF & 1 \\ \hline
		LED SMD 0603 Verde & 2 \\ \hline
		Diodo SMD LL4148 & 1 \\ \hline
		Fusível PTH & 1 \\ \hline
		Indutor SMD 0805  & 2 \\ \hline
		Terminal Block Verde PTH & 4 \\ \hline
		Terminal 4x1 & 1 \\ \hline
		Transistor SMD NPN & 1 \\ \hline
		Resistor SMD 0603 330R & 1 \\ \hline
		Varistor PTH & 1 \\ \hline
		Resistor SMD 0603 4K7 & 3 \\ \hline
		Resistor SMD 0603 6R & 1 \\ \hline
		Resistor SMD 0603 1K & 6 \\ \hline
		Resistor SMD 0603 2.49R & 1 \\ \hline
		Resistor SMD 2010 499K & 2 \\ \hline
		Resistor SMD 0603 100R & 1 \\ \hline
		Resistor SMD 0603 10K & 4 \\ \hline
		Resistor SMD 0603 2.1K & 2 \\ \hline
		Resistor SMD 0603 470R & 2 \\ \hline
		Resistor SMD 0603 33R & 1 \\ \hline
		Relé 5V PTH & 1 \\ \hline
		Chave tactíl do tipo push & 2 \\ \hline
		ESP-12F & 1 \\ \hline
		Optoisolador SMD & 1 \\ \hline
		Fonte AC/DC PTH 5V & 1 \\ \hline
		Regulador linerar SMD 3.3V & 1 \\ \hline
		MCP39F521 & 1 \\ \hline
		MCP9700T-E/TT & 1 \\ \hline
		EKMC1601111 & 1 \\ \hline
		
		\end{tabular}
	\end{center}
\end{table}

Em seguida a definição de todos os componentes a serem utilizados na PCB, e as ligações entre eles definidas nos esquemáticos, foi feito o desenho da PCB, representado pela figura \ref{fig:layout_pcb}, levando em conta novamente os documentos disponibilizados pelos fabricantes dos CIs utilizados, visando assim manter a integridade dos sinais. A ferramenta de desenvolvimento utilizada permitiu também obter uma prévia da vista 3D na perspectiva isométrica aproximada do real, retratada na figura \ref{fig:pcb_3d}.

\begin{figure}[H]
	\begin{subfigure}{0.5\textwidth}
		\centering
		\includegraphics[width=0.9\columnwidth]{figuras/Layout_Top}
		\caption{\textit{Top Layer} do \textit{layout} da PCB.}
		\label{fig:Layout_Top}
	\end{subfigure}%
	\begin{subfigure}{0.5\textwidth}
		\centering
		\includegraphics[width=0.9\columnwidth]{figuras/Layout_Bottom}
		\caption{\textit{Bottom Layer} do \textit{layout} da PCB.}
		\label{fig:Layout_Bottom}
	\end{subfigure}%
	\caption{Camadas \textit{Top} e \textit{Bottom} da PCB.}
	\label{fig:layout_pcb}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.65\columnwidth]{figuras/Layout_3D_Isometric}
	\caption{Visão isométrica da representação 3D do \textit{layout} da PCB.}
	\label{fig:pcb_3d}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{\textit{Firmware}}
\label{section_firmware}

A partir das informações contidas no capítulo \ref{chapter:arquitetura_requisitos}, foi possível elaborar um algoritmo da funcionamento do \textit{firmware}, representando na figura \ref{fig:Firmware_Block_Diagram}, capaz de englobar as funcionalidades previamente levantadas. Tal diagrama foi elaborado com o intuito de guiar e facilitar o desenvolvimento deste pilar do projeto.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.328\columnwidth]{figuras/Firmware_Block_Diagram}
	\caption{Diagrama em blocos do algoritmo de funcionamento do \textit{firmware}.}
	\label{fig:Firmware_Block_Diagram}
\end{figure}


\subsection{Comunicação sob o protocolo MQTT por meio da interface Wi-Fi}
Conforme citado na seção \ref{section_hardware}, o ESP8266EX apresenta a interface Wi-Fi integrada ao CI, característica que facilita o desenvolvimento do \textit{firmware} para as funcionalidades básicas do Wi-Fi como: 
\begin{itemize}
	\setlength\itemsep{0em}
	\item Conectar em uma rede Wi-Fi por meio do SSID e Senha;
	\item Obtenção de IP nesta rede local;
	\item Acesso à internet pela rede local;
	\item Trocar mensagens por meio de um \textit{socket} na camada TCP;
\end{itemize}

Essas funcionalidades são primordiais para o funcionamento do projeto, uma vez que para trocar mensagens com o aplicativo \textit{mobile} o \textit{hardware} deve conectar em uma rede Wi-Fi com acesso à internet. 

Conectada à uma rede com acesso à internet, o \textit{hardware} é capaz de comunicar-se com o \textit{broker} MQTT e trocar mensagens, a partir do tópico escolhido. Conforme a figura \ref{fig:Firmware_Block_Diagram}, após obter êxito na comunicação com o \textit{broker}, o microcontrolador realiza o \textit{subscribe} no tópico de recebimento de mensagens e espera por novas requisições.

Cada funcionalidade foi representada por um tipo de mensagem, conforme a tabela \ref{table:mqtt_mensagens}, para que o microcontrolador fosse capaz de interpretar, executar e responder às requisições provenientes do aplicativo mobile, conforme o fluxo representado pela figura \ref{fig:firmware_mensagem_placa_app}.

\begin{table}[h!]	
	\caption{Mensagens de requisições de funcionalidades}
	\label{table:mqtt_mensagens}
	\begin{center}
		\begin{tabular}{|c|C{7cm}|}
			\hline
			Mensagem & Funcionalidade \\ \hline
			"AC\_On" & Ligar condicionador de ar \\ \hline
			"AC\_Off" & Desligar condicionador de ar \\ \hline
			"Energy\_Info" & Verificar valores de energia elétrica \\ \hline
			"Presence\_Sensor" & Verificar presença humana\\ \hline
			"Set\_On;hh;mm" & Escolher horário para ligar (onde hh e mm representam a hora e o minuto respectivamente)\\ \hline
			"Set\_Off;hh;mm" & Escolher horário para desligar (onde hh e mm representam a hora e o minuto respectivamente)\\ \hline
		\end{tabular}
	\end{center}
\end{table}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.85\columnwidth]{figuras/firmware_mensagem_placa_app}
	\caption{Fluxo de requisição no ponto de vista do \textit{firmware}.}
	\label{fig:firmware_mensagem_placa_app}
\end{figure}

\subsection{\textit{Driver} de controle dos periféricos}
Conforme retratado na subseção \ref{subsec:metodos_firmware}, o \textit{Driver} é responsável por controlar os periféricos, garantindo que as funcionalidades, no mundo físico, sejam executadas. Para a aplicação, o \textit{driver} controla o acionamento do condicionador de ar, realiza a leitura dos valores de energia elétrica e verifica a presença humana a partir da leitura no sensor.

Para acionar o condicionador de ar, o \textit{Driver} controla uma GPIO (General Purpose Input Output). Para "ligar" o dispositivo a GPIO mantem-se em nível lógico baixo e para "desligar" o dispositivo a GPIO mentem-se em nível lógico alto. Esta lógica invertida é dada pelo uso de um transistor do tipo NPN no circuito de acionamento implementado, ilustrado na figura \ref{fig:Schematic_Power_Supply}.

Para obter os valores de energia elétrica - tensão alternada, corrente alternada, frequência da rede elétrica, potência ativa e fator de potência -, o \textit{Driver} comunica por interface I2C com o CI MCP39F521, figura \ref{fig:MCP39F521}. É então realizada uma requisição de um dos registrados do CI, onde as informações ficam armazenadas, que retorna um pacote de 35 \textit{bytes} como resposta. Para interpretar o pacote são usadas funções lógicas de AND e deslocamento de \textit{bits}.

Para verificar a presença humana, o \textit{Driver} realiza a leitura de uma GPIO conectada à saída do sensor de presença. Este sensor de presença mantém sua saída em nível lógico alto ao detectar seres humanos e mantém seu nível lógico baixo quando não detecta seres humanos.


\subsection{Monitoramento dos sensores}

Baseando-se na descrição do sistema retratada no capítulo \ref{chapter:arquitetura_requisitos}, foram elaborados 2 (dois) algorítimos para o monitoramento dos sensores. O primeiro referente ao circuito responsável pela leitura da energia elétrica e os níveis aceitáveis para o funcionamento correto do condicionador de ar e o segundo referente ao sensor de presença no local onde o condicionador de ar está instalado.

Em relação ao primeiro, o objetivo é garantir que os parâmetros de energia elétrica entregues ao condicionador de ar estejam suficientes para o perfeito funcionamento dele, considerando uma certa variação de 10\% dos valores de tensão alternada e frequência da rede elétrica, conforme citado no capítulo \ref{chapter:arquitetura_requisitos}. Portanto, para realizar esta proteção contra mal funcionamentos, foi desenvolvida uma rotina responsável por realizar leituras constantes no MCP39F521, desativando assim a alimentação do condicionador ao verificar algum parâmetro fora da variação aceita.

Em relação ao segundo, o objetivo é informar ao usuário caso haja consumo de energia no condicionador de ar na ausência de pessoas no cômodo em que o dispositivo está instalado, possibilitando assim a economia de energia caso o usuário tenha esquecido aquele ligado. Portanto, para realizar esta funcionalidade, foi desenvolvida uma rotina capaz de verificar constantemente a presença humana, realizando leituras no sensor de presença, representando na figura \ref{fig:EKMC1601111}.


\section{Aplicativo \textit{mobile}}
\label{section_software}
Para esta tarefa, foi realizada a análise da descrição do sistema, retratada no capítulo \ref{chapter:arquitetura_requisitos}, que permitiu levantar as funcionalidades a serem disponibilizadas ao usuário no aplicativo \textit{mobile}, sendo elas: ligar ou desligar o condicionador de ar, verificar o consumo de energia elétrica, verificar presença humana, escolher horário para ligar e para desligar o condicionador de ar.

Para esta aplicação, primeiramente foi desenvolvida a comunicação com o \textit{broker} MQTT e a troca de mensagens com o \textit{hardware} por meio do tópico escolhido, respeitando o fluxograma representado pela figura, \ref{fig:firmware_mensagem_app_placa}. Em seguida, desenvolveu-se a interação do usuário com o sistema a partir da escolha da funcionalidade.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.85\columnwidth]{figuras/firmware_mensagem_app_placa}
	\caption{Fluxo de requisição no ponto de vista do aplicativo \textit{mobile}.}
	\label{fig:firmware_mensagem_app_placa}
\end{figure}

A partir disso, as funcionalidades citadas anteriormente foram desenvolvidas seguindo os tipos de mensagens previamente retratados na tabela \ref{table:mqtt_mensagens}, finalizando-se assim a elaboração do \textit{backend} do aplicativo \textit{mobile}, no qual é totalmente representado pelas imagens \ref{fig:app_inventor_on_off}, \ref{fig:app_inventor_energia}, \ref{fig:app_inventor_temporizador}, \ref{fig:app_inventor_sensor_presenca} e \ref{fig:app_inventor_resposta} referentes aos diagramas de lógicas na plataforma App Inventor.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.65\columnwidth]{figuras/app_inventor/app_inventor_on_off}
	\caption{Bloco de funcionalidade do App Inventor para a função liga/desliga.}
	\label{fig:app_inventor_on_off}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.65\columnwidth]{figuras/app_inventor/app_inventor_energia}
	\caption{Bloco de funcionalidade do App Inventor para obter informações do consumo de energia elétrica.}
	\label{fig:app_inventor_energia}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.55\columnwidth]{figuras/app_inventor/app_inventor_temporizador}
	\caption{Bloco de funcionalidade do App Inventor para os temporizadores de liga/desliga.}
	\label{fig:app_inventor_temporizador}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.55\columnwidth]{figuras/app_inventor/app_inventor_sensor_presenca}
	\caption{Bloco de funcionalidade do App Inventor verificação da presença humana.}
	\label{fig:app_inventor_sensor_presenca}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.75\columnwidth]{figuras/app_inventor/app_inventor_resposta}
	\caption{Bloco de funcionalidade do App Inventor obtenção da resposta do \textit{firmware} às requisições.}
	\label{fig:app_inventor_resposta}
\end{figure}

Para o \textit{frontend}, foi inicialmente analisada a interatividade com o aplicativo a nível de usuário com botões sem ícones. Observou-se então que a falta de ilustração das funcionalidades nos botões tornava o aplicativo não intuitivo, portanto foram escolhidos os ícones, retratados na figura \ref{fig:icones_app}, que mais se aproximassem na retratividade das funcionalidades descritas, além disso, para mostrar ao usuário o retorno das requisições realizadas foi utilizada uma caixa de texto.

\begin{figure}[H]
	\begin{subfigure}{1\textwidth}
		\centering
		\includegraphics[width=0.5\columnwidth]{figuras/on_off_icon}
		\caption{Ícone da função Liga/Desliga.}
		\label{fig:on_off_icon}
	\end{subfigure}%
	\\
	\begin{subfigure}{.475\textwidth}
		\centering
		\includegraphics[width=0.5\columnwidth]{figuras/energy_icon}
		\caption{Ícone da função para obter os níveis da energia elétrica no condicionador de ar.}
		\label{fig:energy_icon}
	\end{subfigure}
	\space\space\space\space\space\space
	\begin{subfigure}{.475\textwidth}
		\centering
		\includegraphics[width=0.62\columnwidth]{figuras/motion_detection_icon}
		\caption{Ícone da função da verificação de presença humana.}
		\label{fig:motion_detection_icon}
	\end{subfigure}%
	\\
	\begin{subfigure}{.5\textwidth}
		\centering
		\includegraphics[width=0.5\columnwidth]{figuras/time_picker_on_icon}
		\caption{Ícone da função de temporizador para ligar.}
		\label{fig:time_picker_on_icon}
	\end{subfigure}
	\begin{subfigure}{.5\textwidth}
		\centering
		\includegraphics[width=0.5\columnwidth]{figuras/time_picker_off_icon}
		\caption{Ícone da função de temporizador para desligar.}
		\label{fig:time_picker_off_icon}
	\end{subfigure}
	\caption{Ícones do aplicativo \textit{mobile}.}
	\label{fig:icones_app}
\end{figure}
